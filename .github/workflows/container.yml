name: deploy-container

on:
    push:
        branches:
            - main
        paths:
            - 'packages/container/**'

jobs:
    build:
        name: Build
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: packages/container

        env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_DEFAULT_REGION: 'eu-central-1'

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install dependencies
              run: npm install

            - name: Build and deploy to S3
              run: |
                  npm run build
                  aws s3 sync dist s3://${{ secrets.AWS_S3_BUCKET_NAME }}/container/latest

    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up AWS CLI
              uses: shinyinc/action-aws-cli@v1.2

            - name: Deploy to S3
              run: aws s3 sync dist s3://${{ secrets.AWS_S3_BUCKET_NAME }}/container/latest
